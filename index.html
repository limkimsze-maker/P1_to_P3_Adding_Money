<!doctype html>
<html lang="en">
<head>
<link rel="icon" href="./kimsze_sharp16.ico?v=20260111a" sizes="any">
<link rel="shortcut icon" href="./kimsze_sharp16.ico?v=20260111a">
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Addition â€” Money Algorithm (Step-by-step)</title>

  <!-- âœ… Always-Clear on Load (Default Build Contract) -->
  <script>
  (function(){
    const ACTIVITY_ID = (window.ACTIVITY_ID || (location.origin + location.pathname));
    try{
      const del = [];
      for(let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        if(!k) continue;
        if(k === ACTIVITY_ID) del.push(k);
        if(k.startsWith(ACTIVITY_ID+"::")) del.push(k);
        if(k.startsWith("sls_scope::"+ACTIVITY_ID)) del.push(k);
        if(k.startsWith("UFCO-firstSubmit::"+ACTIVITY_ID)) del.push(k);
        if(k.startsWith("sls_unlike_payload::"+ACTIVITY_ID)) del.push(k);
      }
      del.forEach(k => localStorage.removeItem(k));
      try{
        const bc = new BroadcastChannel("xapi-state");
        bc.postMessage({ type:"clear", activityId: ACTIVITY_ID, ts: Date.now() });
        bc.close();
      }catch(e){}
    }catch(e){}
  })();
  </script>

  <style>
    :root{
      --bg:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;

      --card:#ffffff;
      --shadow:0 14px 30px rgba(2,6,23,.10);
      --radius:22px;

      /* Token sizes */
      --coin: 44px;
      --coinFont: 14px;
      --noteW: 78px;
      --noteH: 44px;

      /* âœ… unify token â€œfaceâ€ height so 5Â¢ / 10Â¢ / $1 align with $10 / $100 */
      --tokenH: 44px;

      /* Animation */
      --moveDur: 1400ms;
      --regroupDur: 1100ms;
      --ease: cubic-bezier(.2,.85,.2,1);

      /* Layout */
      --topbarH: 62px;
      --gap: 14px;
      --maxW: 1320px;

      /* Algorithm column alignment */
      --colCount: 5;          /* set by JS */
      --algoColW: 54px;
      --algoGap: 14px;

      /* âœ… Original cute lion watermark (generic + copyright-safe) */
      --lionMark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 120 120'%3E%3Cg fill='none' stroke='%230f172a' stroke-width='6' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M60 18c-20 0-36 16-36 36 0 22 14 40 36 40s36-18 36-40c0-20-16-36-36-36z'/%3E%3Cpath d='M38 48c-10-2-16-10-16-20 10 2 18 8 22 16'/%3E%3Cpath d='M82 48c10-2 16-10 16-20-10 2-18 8-22 16'/%3E%3Cpath d='M48 62c4 4 8 6 12 6s8-2 12-6'/%3E%3Cpath d='M56 74c2 2 4 3 4 3s2-1 4-3'/%3E%3Ccircle cx='46' cy='56' r='2'/%3E%3Ccircle cx='74' cy='56' r='2'/%3E%3C/g%3E%3C/svg%3E");
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--ink);
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      -webkit-text-size-adjust: 100%;
    }

    .topbar{
      height:auto;
      min-height: var(--topbarH);
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(8px);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding: 10px 14px;
      position: sticky;
      top: 0;
      z-index: 20;
      padding-top: calc(10px + env(safe-area-inset-top));
    }
    .title{
      display:flex;
      align-items:baseline;
      gap:10px;
      font-weight:1000;
      letter-spacing:.2px;
      min-width: 140px;
    }
    .title .big{ font-size: 18px; }

    .actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      padding:8px 10px;
      display:flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      font-weight:1000;
      color: var(--muted);
      white-space:nowrap;
    }
    .pill strong{ color: var(--ink); }
    .btn{
      border:1px solid var(--line);
      background:#fff;
      border-radius: 14px;
      padding: 10px 12px;
      font-weight:1000;
      font-size:13px;
      cursor:pointer;
      white-space:nowrap;
      transition: transform .08s ease;
      touch-action: manipulation;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background:#0f172a;
      border-color:#0f172a;
      color:#fff;
    }
    .btn:disabled{
      opacity:.45;
      cursor:not-allowed;
      transform:none;
    }

    .wrap{
      height:auto;
      min-height: calc(100vh - var(--topbarH));
      max-width: var(--maxW);
      margin: 0 auto;
      padding: 12px 14px 14px;
      display:grid;
      grid-template-columns: 1.55fr 1.2fr;
      gap: var(--gap);
      overflow: visible;
      min-height: 0;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      min-height:0;
    }

    .leftCard{
      display:grid;
      grid-template-rows: auto 1fr auto;
      min-height:0;
    }
    .cardHead{
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .cardHead .h{
      font-weight:1000;
      letter-spacing:.2px;
    }
    .cardHead .sub{
      margin-top:2px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
    }

    /* âœ… bigger question for pupils */
    #prompt{
      font-size: 22px;
      line-height: 1.25;
      font-weight: 1000;
    }
    @media (max-width: 640px){
      #prompt{ font-size: 20px; }
    }

    .miniRule{
      margin-top: 6px;
      font-size: 12px;
      font-weight: 1000;
      color:#0369a1;
      background: rgba(224,242,254,.65);
      border: 1px dashed rgba(14,165,233,.45);
      border-radius: 14px;
      padding: 8px 10px;
      display:inline-flex;
      gap:8px;
      align-items:center;
    }

    .matWrap{
      padding: 12px 14px 12px;
      min-height:0;
    }
    .mat{
      position: relative;
      height: 100%;
      min-height: 460px;
      border-radius: 22px;
      border: 2px solid rgba(15,23,42,.16);
      overflow:hidden;
      background:#fff;
    }

    .cols{
      position:absolute;
      inset:0;
      display:grid;
      grid-template-columns: repeat(var(--cols, 2), 1fr);
    }
    .col{
      background: linear-gradient(180deg, rgba(241,245,249,.95), rgba(241,245,249,.45));
    }
    .col.tint0{ background: linear-gradient(180deg, rgba(223,247,255,.95), rgba(223,247,255,.42)); }
    .col.tint1{ background: linear-gradient(180deg, rgba(255,241,219,.90), rgba(255,241,219,.40)); }
    .col.tint2{ background: linear-gradient(180deg, rgba(255,228,241,.85), rgba(255,228,241,.35)); }
    .col.tint3{ background: linear-gradient(180deg, rgba(239,231,255,.92), rgba(239,231,255,.42)); }
    .col.tint4{ background: linear-gradient(180deg, rgba(233,255,241,.92), rgba(233,255,241,.42)); }
    .col.tint5{ background: linear-gradient(180deg, rgba(255,246,217,.92), rgba(255,246,217,.42)); }
    .col.tint6{ background: linear-gradient(180deg, rgba(230,240,255,.92), rgba(230,240,255,.42)); }
    .col.tint7{ background: linear-gradient(180deg, rgba(255,232,239,.92), rgba(255,232,239,.42)); }

    body.animating .col{ background: #fff !important; }

    .vSep{
      position:absolute;
      top:0; bottom:0;
      width:2px;
      background: rgba(15,23,42,.10);
      pointer-events:none;
    }
    .hSep{
      position:absolute;
      left:0; right:0;
      top:50%;
      height:2px;
      background: rgba(236,72,153,.78);
      pointer-events:none;
      transform: translateY(-1px);
    }
    .mat.together .hSep{ opacity:0; }
    .mat.together{
      box-shadow: inset 0 0 0 3px rgba(34,197,94,.55);
      border-color: rgba(34,197,94,.65);
    }

    .zones{
      position:absolute;
      inset:0;
      display:grid;
      grid-template-columns: repeat(var(--cols, 2), 1fr);
      grid-template-rows: 1fr 1fr;
      pointer-events:none;
    }
    .zone{
      padding: 10px 10px;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .zoneInner{
      width:100%;
      height:100%;
      display:grid;
      place-items:center;
      min-height:0;
    }

    .fitBox{ transform-origin:center; will-change: transform; }
    .pile{ width:100%; height:100%; transform-origin:center; will-change: transform; }

    /* âœ… single straight line (single column) */
    .pileTwoCol{
      --rowGap: 10px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-end;
      gap: var(--rowGap);
      height: 100%;
    }
    .pileTwoCol[data-place^="d"]{ --rowGap: 8px; }
    .pileTwoCol[data-place^="c"]{ --rowGap: 8px; }

    .token{
      display:inline-block;
      user-select:none;
      pointer-events:none;
    }

    /* âœ… normalize ALL token graphics to same â€œfaceâ€ height */
    .coin,
    .noteCard,
    .coinOct{
      height: var(--tokenH);
    }

    .coin{
      width: var(--coin);
      border-radius:50%;
      display:grid;
      place-items:center;
      position:relative;
      filter: drop-shadow(0 8px 14px rgba(2,6,23,.14));
      overflow:hidden;
    }
    .coin:before{
      content:"";
      position:absolute; inset:0;
      border-radius:50%;
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,.85), rgba(255,255,255,0) 40%),
        radial-gradient(circle at 70% 75%, rgba(0,0,0,.14), rgba(0,0,0,0) 50%);
      mix-blend-mode:overlay;
      pointer-events:none;
    }
    .coin .ring{
      position:absolute;
      inset: calc(var(--coin) * 0.10);
      border-radius:50%;
      border:2px dashed rgba(15,23,42,.18);
      pointer-events:none;
    }
    .coin .inner{
      width: calc(var(--coin) * 0.76);
      height: calc(var(--coin) * 0.76);
      border-radius:50%;
      display:grid;
      place-items:center;
      border:2px solid rgba(15,23,42,.16);
      background:rgba(255,255,255,.35);
      backdrop-filter: blur(3px);
      font-weight:1000;
      letter-spacing:.2px;
      text-align:center;
      line-height:1;
      padding-top: 1px;
    }
    .coin .inner span{font-size: calc(var(--coinFont) * 1.05)}
    .coin .inner small{
      display:block;
      font-size: 10px;
      font-weight:1000;
      letter-spacing:.7px;
      opacity:.85;
      margin-top: 2px;
      text-transform:uppercase;
    }

    .c5{  background: radial-gradient(circle at 30% 25%, #fff, #c7f9cc 40%, #4ade80 100%); }
    .c10{ background: radial-gradient(circle at 30% 25%, #fff, #bae6fd 40%, #38bdf8 100%); }

    .noteCard{
      width: var(--noteW);
      border-radius: 14px;
      border:2px solid rgba(15,23,42,.16);
      background:
        radial-gradient(circle at 18% 30%, rgba(255,255,255,.9), rgba(255,255,255,0) 45%),
        linear-gradient(135deg, rgba(34,197,94,.18), rgba(14,165,233,.14));
      box-shadow:0 10px 18px rgba(2,6,23,.10);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:1000;
      position:relative;
      overflow:hidden;
      user-select:none;
      isolation:isolate;
      padding: 0 6px;
      text-align:center;
      line-height:1;
    }
    .noteCard:before{
      content:"";
      position:absolute;
      inset: 6px;
      border-radius: 10px;
      border:2px dotted rgba(15,23,42,.16);
      pointer-events:none;
      z-index:1;
      opacity:.95;
    }
    .noteCard > *{ position:relative; z-index:2; }
    .noteCard small{
      display:block;
      font-size:10px;
      opacity:.78;
      letter-spacing:1px;
      text-transform:uppercase;
      text-align:center;
      margin-top:2px;
    }
    .noteCard.ten{
      background:
        radial-gradient(circle at 18% 30%, rgba(255,255,255,.9), rgba(255,255,255,0) 45%),
        linear-gradient(135deg, rgba(251,191,36,.18), rgba(139,92,246,.12));
    }
    .noteCard.fifty{
      background:
        radial-gradient(circle at 18% 30%, rgba(255,255,255,.9), rgba(255,255,255,0) 45%),
        linear-gradient(135deg, rgba(239,68,68,.16), rgba(14,165,233,.12));
    }
    .noteCard.thou{
      background:
        radial-gradient(circle at 18% 30%, rgba(255,255,255,.9), rgba(255,255,255,0) 45%),
        linear-gradient(135deg, rgba(167,139,250,.20), rgba(59,130,246,.10));
    }

    /* âœ… $1 coin resized to SAME â€œfaceâ€ height as $10/$100 and 5Â¢/10Â¢ */
    .coinOct{
      width: var(--noteH);
      display:grid;
      place-items:center;
      font-weight:1000;
      border:2px solid rgba(15,23,42,.16);
      filter: drop-shadow(0 10px 16px rgba(2,6,23,.14));
      clip-path: polygon(30% 0%, 70% 0%, 100% 30%, 100% 70%, 70% 100%, 30% 100%, 0% 70%, 0% 30%);
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,.95), rgba(255,255,255,0) 42%),
        radial-gradient(circle at 70% 75%, rgba(0,0,0,.18), rgba(0,0,0,0) 55%),
        linear-gradient(180deg, #fff7c2 0%, #fbbf24 55%, #b45309 100%);
      position:relative;
      user-select:none;
      overflow:hidden;
      isolation:isolate;
      line-height:1;
      text-align:center;
      padding-top: 0;
    }
    .coinOct:before{
      content:"";
      position:absolute;
      inset: 6px;
      clip-path: polygon(30% 0%, 70% 0%, 100% 30%, 100% 70%, 70% 100%, 30% 100%, 0% 70%, 0% 30%);
      border:2px dashed rgba(15,23,42,.16);
      opacity:.9;
      pointer-events:none;
    }
    .coinOct > *{ position:relative; z-index:2; }
    .coinOct span{ font-size: calc(var(--coinFont) * 1.00); }
    .coinOct small{
      display:block;
      font-size:10px;
      font-weight:1000;
      letter-spacing:.7px;
      opacity:.8;
      margin-top:2px;
      text-transform:uppercase;
    }

    .noteCard:after{
      content:"";
      position:absolute;
      inset:0;
      background-image: var(--lionMark);
      background-repeat:no-repeat;
      background-position: 6px 6px;
      background-size: calc(var(--noteH) * 0.92) calc(var(--noteH) * 0.92);
      opacity:.16;
      pointer-events:none;
      z-index:1;
    }

    /* âœ… Big black dot (LOCKED / permanent) */
    .dotSimple{
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #000;
      position:absolute;
      z-index: 10;
      pointer-events:none;
      opacity: 1 !important; /* âœ… lock dot even when "together" */
    }

    .animLayer{
      position: fixed;
      inset: 0;
      pointer-events:none;
      z-index: 80;
    }
    .confettiLayer{
      position: fixed;
      inset: 0;
      pointer-events:none;
      z-index: 95;
      overflow: hidden;
    }
    .ghost{
      position: fixed;
      left:0; top:0;
      will-change: transform, opacity, filter;
      pointer-events:none;
    }
    .movingHidden{ opacity: 0 !important; }

    .eqBar{
      padding: 12px 14px 14px;
      border-top: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(233,243,242,.65), rgba(233,243,242,.18));
      display:flex;
      flex-direction: column;
      align-items:flex-start;
      justify-content:flex-start;
      gap: 8px;
    }
    .eq{
      font-weight: 1000;
      letter-spacing:.2px;
      font-size: clamp(26px, 3.2vw, 46px);
      display:flex;
      align-items:center;
      gap: 12px;
      white-space:nowrap;
      max-width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 2px;
    }
    .ansPill{
      min-width: 110px;
      height: 54px;
      border-radius: 16px;
      border: 3px solid rgba(44,93,0,.35);
      background: rgba(214,255,180,.55);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:1000;
      font-size: 32px;
      color:#000;
      box-shadow: 0 10px 18px rgba(0,0,0,.12);
      flex: 0 0 auto;
    }
    .eqHint{
      font-size:12px;
      color: var(--muted);
      font-weight: 900;
    }
    .ansWords{
      font-size: 14px;
      font-weight: 1000;
      color: #000;
      line-height: 1.25;
      border-left: 5px solid rgba(34,197,94,.55);
      padding-left: 10px;
      display:none;
    }
    .ansWords .muted{
      color: var(--muted);
      font-weight: 900;
      font-size: 12px;
      display:block;
      margin-bottom: 2px;
    }

    .rightCol{
      display:grid;
      grid-template-rows: auto 1fr;
      gap: var(--gap);
      min-height:0;
    }

    .panelHead{
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .panelHead .h{
      font-weight:1000;
      letter-spacing:.2px;
    }
    .panelHead .small{
      font-size:12px;
      color: var(--muted);
      font-weight: 900;
      white-space:nowrap;
    }

    .panelBody{
      display:grid;
      grid-template-rows: 250px auto;
      gap: 14px;
      padding: 12px 14px 14px;
      min-height:0;
    }
    .stack{ justify-items: start; }

    .algoBox{
      border-radius: 18px;
      background:#fff;
      border: 1px solid var(--line);
      box-shadow: 0 10px 18px rgba(0,0,0,.08);
      overflow: hidden;
      display:grid;
      place-items:center;
      padding: 0px;
      height: 300px;
    }

    .algoFit{
      transform-origin: center;
      will-change: transform;
      transform: translateY(120px);
    }

    .pvLabels{
      display:grid;
      grid-template-columns: repeat(var(--colCount), var(--algoColW));
      column-gap: var(--algoGap);
      align-items:center;
      justify-content:start;
      margin-bottom: 8px;
    }
    .band{
      height: 34px;
      border-radius: 14px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:1000;
      letter-spacing:.2px;
      font-size: 18px;
      user-select:none;
    }
    .band.dollars{
      background: rgba(255, 228, 194, .85);
      color:#b91c1c;
      border: 2px solid rgba(248,113,113,.35);
    }
    .band.cents{
      background: rgba(191, 219, 254, .85);
      color:#0369a1;
      border: 2px solid rgba(59,130,246,.28);
    }

    .stack{
      display:grid;
      grid-template-columns: 54px auto;
      gap: 10px;
      align-items:end;
      justify-items:end;
    }
    .moneySign{
      width: 54px;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      font-weight:1000;
      color:#000;
      line-height:1;
      font-size: 42px;
      padding: 0;
      transform: none;
    }
    .moneySign.plus{ font-size: 42px; transform: none; }

    .carryRow{
      display:grid;
      grid-template-columns: repeat(var(--colCount), var(--algoColW));
      column-gap: var(--algoGap);
      align-items:end;
      justify-content:start;
      font-weight:1000;
      white-space:nowrap;
      font-size: 26px;
      line-height: .9;
      margin-bottom: 2px;
    }
    .carryRow span{
      width: var(--algoColW);
      height: 28px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .carryRow .blank{ opacity:0; }
    .carryRow .carry{
      background: rgba(250,204,21,.35);
      border: 2px solid rgba(245,158,11,.6);
      border-radius: 12px;
      padding: 0 8px;
      transform: translateY(2px);
    }

    .digitsCol{
      display:grid;
      grid-template-columns: repeat(var(--colCount), var(--algoColW));
      column-gap: var(--algoGap);
      align-items:end;
      justify-content:start;
      font-weight:1000;
      color:#000;
      white-space:nowrap;
      font-size: 52px;
      line-height: .92;
    }
    .digitsCol span{
      width: var(--algoColW);
      text-align:center;
      display:block;
    }
    .digitsCol .blank{ opacity:0; }

    .barLine{
      height: 6px;
      width: 100%;
      background: #0f172a;
      border-radius: 999px;
      margin-top: 2px;
    }

    .resultRow{
      display:grid;
      grid-template-columns: repeat(var(--colCount), var(--algoColW));
      column-gap: var(--algoGap);
      align-items:center;
      justify-content:start;
      margin-top: 6px;
    }
    .resBox{
      width: var(--algoColW);
      height: 50px;
      border-radius: 16px;
      border: 3px solid rgba(44,93,0,.35);
      background: rgba(214,255,180,.55);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:1000;
      font-size: 30px;
      color:#000;
      box-shadow: 0 10px 18px rgba(0,0,0,.12);
    }
    .resBox.mystery{ color: rgba(0,0,0,.35); }
    .resBox.blankish{
      background: transparent;
      border-color: transparent;
      box-shadow:none;
      color: transparent;
    }

    .lowerPanel{
      border-radius: 18px;
      background:#fff;
      border: 1px solid var(--line);
      box-shadow: 0 10px 18px rgba(0,0,0,.08);
      overflow:hidden;
    }

    .stepCard{
      border: 2px solid rgba(245,158,11,.75);
      border-radius: 18px;
      margin: 40px 12px 10px;
      padding: 12px 12px;
      display:grid;
      gap: 6px;
      background:#fff;
      margin-bottom: 40px;
    }
    .stepTitle{
      font-weight:1000;
      font-size: 34px;
      letter-spacing:.2px;
      color: #f59e0b;
      text-decoration: underline;
      text-underline-offset: 6px;
    }
    .stepText{
      font-weight:1000;
      font-size: 20px;
      color:#000;
    }
    .stepEq{
      font-weight:1000;
      font-size: 22px;
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .miniBox{
      width: 64px;
      height: 44px;
      border-radius: 14px;
      border: 3px solid rgba(44,93,0,.35);
      background: rgba(214,255,180,.55);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:1000;
      font-size: 26px;
      color:#000;
      box-shadow: 0 10px 18px rgba(0,0,0,.12);
    }
    .miniBox.mystery{ color: rgba(0,0,0,.35); }

    .teacherWrap{
      padding: 10px 12px 12px;
      display:grid;
      gap: 10px;
    }
    .fields{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    label{
      font-size: 12px;
      font-weight: 900;
      color: var(--muted);
      display:block;
      margin-bottom: 6px;
    }
    input[type="text"], select{
      width:100%;
      padding: 10px 10px;
      border: 1px solid var(--line);
      border-radius: 14px;
      font-size: 14px;
      font-weight: 900;
      outline:none;
      background:#fff;
    }
    .rowBtns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-top: 2px;
    }
    .seg{
      display:flex;
      border:1px solid var(--line);
      border-radius: 14px;
      overflow:hidden;
      background:#fff;
    }
    .seg button{
      border:0;
      background:transparent;
      padding: 10px 12px;
      font-weight:1000;
      font-size:13px;
      color: var(--muted);
      cursor:pointer;
      white-space:nowrap;
    }
    .seg button.active{
      background:#0f172a;
      color:#fff;
    }
    .seg button:disabled{
      opacity:.45;
      cursor:not-allowed;
    }

    .noteErr{
      font-size:12px;
      font-weight: 900;
      color:#b91c1c;
      background: rgba(239,68,68,.08);
      border: 1px solid rgba(239,68,68,.25);
      padding: 10px 12px;
      border-radius: 14px;
      display:none;
    }

    .randRow{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:end;
    }
    .randRow .btn{ width:100%; }

    .childPanel{
      margin: 0 12px 12px;
      border-radius: 18px;
      border: 2px dashed rgba(14,165,233,.55);
      background: linear-gradient(180deg, rgba(224,242,254,.65), rgba(255,255,255,.9));
      padding: 20px;
      display:grid;
      gap: 10px;
    }
    .childTitleRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap: wrap;
    }
    .childTitle{
      font-weight:1000;
      letter-spacing:.2px;
      color:#0369a1;
      font-size: 16px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .childBadge{
      font-size:12px;
      font-weight:1000;
      color: var(--muted);
      background:#fff;
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      white-space:nowrap;
    }
    .childGrid{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:end;
    }
    .childMsg{
      font-size:12px;
      font-weight: 900;
      border-radius: 14px;
      padding: 10px 12px;
      border: 1px solid transparent;
      display:none;
      line-height:1.25;
    }
    .childMsg.ok{
      display:block;
      color:#14532d;
      background: rgba(34,197,94,.10);
      border-color: rgba(34,197,94,.25);
    }
    .childMsg.bad{
      display:block;
      color:#7f1d1d;
      background: rgba(239,68,68,.10);
      border-color: rgba(239,68,68,.25);
    }

    @keyframes panelPulse{
      0%{ box-shadow: 0 0 0 rgba(14,165,233,0); }
      35%{ box-shadow: 0 0 0 6px rgba(14,165,233,.18); }
      70%{ box-shadow: 0 0 0 0 rgba(14,165,233,0); }
      100%{ box-shadow: 0 0 0 rgba(14,165,233,0); }
    }
    .pulseTeacher{
      animation: panelPulse 900ms ease-in-out 0s 2;
      border-color: rgba(14,165,233,.55) !important;
    }
    .moneyInput{
      position: relative;
    }
    .moneyPrefix{
      position:absolute;
      left:12px;
      top:50%;
      transform: translateY(-50%);
      font-weight:1000;
      color:#0f172a;
      opacity:.9;
    }
    .moneyInput input{
      padding-left: 28px;
    }

    .credit{
      position: fixed;
      right: 14px;
      bottom: 10px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
      z-index: 5;
    }

    @media (max-width: 980px){
      .wrap{ grid-template-columns: 1fr; }
      .algoBox{ height: 260px; }
      .panelBody{ grid-template-rows: 330px auto; }
    }

    @media (max-width: 640px){
      :root{
        --gap: 10px;
        --algoColW: 44px;
        --algoGap: 10px;
        --tokenH: 44px;
      }

      .title .big{ font-size: 16px; }
      .actions{ gap:8px; justify-content:flex-start; }
      .pill{ font-size: 11px; padding: 6px 8px; }
      .btn{ padding: 10px 10px; font-size: 13px; border-radius: 14px; }

      .mat{ min-height: 360px; }

      .panelBody{
        grid-template-rows: auto auto;
        gap: 12px;
      }
      .algoBox{
        height: 330px;
        min-height: 240px;
        padding: 10px;
      }

      .digitsCol{ font-size: 40px; }
      .moneySign, .moneySign.plus{ font-size: 36px; width: 46px; }
      .stack{ grid-template-columns: 15px auto; gap: 0px; }

      .resBox{ height: 44px; font-size: 26px; border-radius: 14px; }

      .stepTitle{ font-size: 26px; }
      .stepText{ font-size: 16px; }
      .stepEq{ font-size: 16px; }
      .miniBox{ width: 58px; height: 40px; font-size: 22px; }

      .eq{ font-size: clamp(22px, 7vw, 38px); gap: 8px; }
      .ansPill{ height: 46px; font-size: 26px; border-radius: 14px; }

      .fields{ grid-template-columns: 1fr; }
      .randRow{ grid-template-columns: 1fr; }
      .rowBtns{ justify-content:flex-start; }
      .seg{ width: 100%; }
      .seg button{ flex: 1 1 auto; text-align:center; }

      .childGrid{ grid-template-columns: 1fr; }
      #btnChildCheck{ width: 100%; }

      .credit{
        position: static;
        padding: 10px 12px 14px;
        text-align: right;
      }
    }
  </style>

  <!-- Counter.dev (Kim Sze standard) -->
  <script src="https://cdn.counter.dev/script.js" data-id="825e93b6-ce99-40ef-8bcc-125f13297433" data-utcoffset="8"></script>
</head>
<body>
  <div class="topbar">
    <div class="title">
      <span class="big">Money Addition</span>
    </div>

    <div class="actions">
      <div class="pill"><span>A:</span><strong id="pillA">$12.75</strong></div>
      <div class="pill"><span>B:</span><strong id="pillB">$8.60</strong></div>

      <button class="btn" id="btnReset">â†º Reset</button>
      <button class="btn primary" id="btnNext">Next Step â–¶</button>
      <button class="btn" id="btnDone" disabled>Done âœ“</button>
    </div>
  </div>

  <div class="wrap">
    <section class="card leftCard">
      <div class="cardHead">
        <div>
          <div class="h" id="prompt">(a) A toy costs $12.75. A puzzle costs $8.60. What is the total amount?</div>
          <div class="sub">Click <b>Next Step</b> to add the <b>cents</b> first, then the <b>dollars</b>.</div>
          <div class="miniRule">âœ… <span>Align the decimal dots (.) before adding.</span></div>
        </div>
      </div>

      <div class="matWrap">
        <div class="mat" id="mat">
          <div class="cols" id="cols"></div>
          <div class="hSep" id="hSep"></div>
          <div class="zones" id="zones"></div>
        </div>
      </div>

      <div class="eqBar">
        <div class="eq">
          <span id="eqA">$12.75</span>
          <span>+</span>
          <span id="eqB">$8.60</span>
          <span>=</span>
          <span class="ansPill" id="eqAns">$?</span>
        </div>
        <div class="eqHint" id="eqHint">Click Next Step</div>

        <div class="ansWords" id="ansWords">
          <span class="muted">Answer in words (Singapore style)</span>
          <span id="ansWordsText"></span>
        </div>
      </div>
    </section>

    <aside class="card" id="teachCard">
      <div class="panelHead">
        <div class="h">Teaching Panel</div>
        <div class="small">Align dots â†’ Add â†’ Regroup</div>
      </div>

      <div class="panelBody">
        <div class="algoBox">
          <div class="algoFit" id="algoFit">
            <div class="stack">
              <div></div>
              <div class="pvLabels" id="pvLabels"></div>

              <div></div>
              <div class="carryRow" id="carryRow"></div>

              <div class="moneySign" id="signA">$</div>
              <div class="digitsCol" id="rowA"></div>

              <div class="moneySign plus" id="signB">+$</div>
              <div class="digitsCol" id="rowB"></div>

              <div></div>
              <div class="barLine"></div>

              <div class="moneySign" id="signR">$</div>
              <div class="resultRow" id="resRow"></div>
            </div>
          </div>
        </div>

        <div class="lowerPanel" id="lowerPanel">
          <div class="stepCard" id="stepCard">
            <div class="stepTitle" id="stepTitle">STEP 1</div>
            <div class="stepText" id="stepText">Add the cents.</div>
            <div class="stepEq">
              <span id="stepL">?</span>
              <span>=</span>
              <span class="miniBox mystery" id="stepAns">?</span>
            </div>
          </div>

          <div class="childPanel" id="childPanel">
            <div class="childTitleRow">
              <div class="childTitle">ðŸ§’ Child Try-It Panel</div>
              <div class="childBadge">Try: <span id="childEq">$12.75 + $8.60</span></div>
            </div>

            <div class="childGrid">
              <div>
                <label>Your answer (2 d.p., e.g., 0.80, 21.35)</label>
                <div class="moneyInput">
                  <span class="moneyPrefix">$</span>
                  <input id="childAns" type="text" inputmode="decimal" placeholder="0.00"/>
                </div>
              </div>
              <button class="btn primary" id="btnChildCheck">Check âœ…</button>
            </div>

            <div class="childMsg" id="childMsg"></div>
          </div>

          <div class="teacherWrap">
            <div class="fields">
              <div>
                <label>Amount A (0â€“999.95)</label>
                <input id="inA" type="text" inputmode="decimal" value="12.75"/>
              </div>
              <div>
                <label>Amount B (0â€“999.95)</label>
                <input id="inB" type="text" inputmode="decimal" value="8.60"/>
              </div>
            </div>

            <div class="randRow">
              <div>
                <label>Random: amount range (A &amp; B)</label>
                <select id="digitsSel">
                  <option value="99.95">Up to $99.95</option>
                  <option value="199.95">Up to $199.95</option>
                  <option value="499.95">Up to $499.95</option>
                </select>
              </div>
              <button class="btn" id="btnRandom">ðŸŽ² Random Amounts</button>
            </div>

            <div class="fields">
              <div>
                <label>Step order (no regrouping only)</label>
                <select id="orderSel">
                  <option value="centsFirst" selected>Cents â†’ Dollars</option>
                  <option value="dollarsFirst">Dollars â†’ Cents</option>
                </select>
              </div>
              <div>
                <label>&nbsp;</label>
                <div style="font-size:12px;color:var(--muted);font-weight:1000;line-height:1.25;padding:10px 2px;">
                  Enabled only when the sum needs <b>no renaming</b>.
                </div>
              </div>
            </div>

            <div class="fields" id="renameFields">
              <div>
                <label>Renaming: 5Â¢ â†’ 10Â¢</label>
                <select id="ren_o">
                  <option value="any" selected>Any</option>
                  <option value="rename">Renaming</option>
                  <option value="no">No renaming</option>
                </select>
              </div>
              <div>
                <label>Renaming: 10Â¢ â†’ $1</label>
                <select id="ren_t">
                  <option value="any" selected>Any</option>
                  <option value="rename">Renaming</option>
                  <option value="no">No renaming</option>
                </select>
              </div>
              <div>
                <label>Renaming: $1 â†’ $10</label>
                <select id="ren_h">
                  <option value="any" selected>Any</option>
                  <option value="rename">Renaming</option>
                  <option value="no">No renaming</option>
                </select>
              </div>
              <div>
                <label>Renaming: $10 â†’ $100</label>
                <select id="ren_th">
                  <option value="any" selected>Any</option>
                  <option value="rename">Renaming</option>
                  <option value="no">No renaming</option>
                </select>
              </div>
            </div>

            <div class="rowBtns">
              <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn primary" id="btnApply">Apply</button>
                <button class="btn" id="btnSwap">Swap A/B</button>
              </div>

              <div class="seg" aria-label="Display mode">
                <button type="button" id="btnBlocks" class="active" disabled>Notes &amp; Coins</button>
              </div>
            </div>

            <div class="noteErr" id="errBox"></div>
            <div style="font-size:12px; color:var(--muted); font-weight:900;">
              <span id="ruleNote"></span>
            </div>
          </div>
        </div>
      </div>
    </aside>
  </div>

  <div class="credit">Designed by Lim Kim Sze Â© 2026</div>
  <div class="animLayer" id="animLayer"></div>
  <div class="confettiLayer" id="confettiLayer"></div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  /* =========================
     MONEY MODEL (no 1Â¢)
     - amounts are in CENTS (integer)
     - last digit of cents is always 0 or 5 (i.e. step = 5 cents)
     - columns shown: $100 $10 $1 |dot| 10Â¢ 5Â¢
     âœ… Dot is NOT a column anymore (just a locked visual marker).
     ========================= */
  const STEP_CENTS = 5;
  const MAX_DOLLARS = 999;
  const MAX_CENTS = MAX_DOLLARS * 100 + 95;

  // âœ… FINAL COLUMNS (left â†’ right): d100, d10, d1, c10, c5
  const COLS = ["d100","d10","d1","c10","c5"];
  // âœ… Visual dot BETWEEN d1 (index 2) and c10 (index 3)
  const DOT_INDEX = 3; // boundary position (after 3 columns)

  const BASE = {
    c5:  2,
    c10: 10,
    d1:  10,
    d10: 10,
    d100:10,
    d1000:10
  };

  const PLACE_META = {
    d100: { label:"hundreds of dollars",  short:"$100"  },
    d10:  { label:"tens of dollars",      short:"$10"   },
    d1:   { label:"ones of dollars",      short:"$1"    },
    c10:  { label:"tens of cents",        short:"10Â¢"   },
    c5:   { label:"five cents",           short:"5Â¢"    },
  };

  const ui = {
    pillA: $("pillA"), pillB: $("pillB"),
    eqA: $("eqA"), eqB: $("eqB"), eqAns: $("eqAns"), eqHint: $("eqHint"),
    ansWords: $("ansWords"), ansWordsText: $("ansWordsText"),
    prompt: $("prompt"),
    inA: $("inA"), inB: $("inB"),
    digitsSel: $("digitsSel"), btnRandom: $("btnRandom"),
    orderSel: $("orderSel"),
    btnApply: $("btnApply"), btnSwap: $("btnSwap"),
    btnBlocks: $("btnBlocks"),
    btnReset: $("btnReset"), btnNext: $("btnNext"), btnDone: $("btnDone"),
    mat: $("mat"), cols: $("cols"), zones: $("zones"),
    pvLabels: $("pvLabels"),
    carryRow: $("carryRow"),
    rowA: $("rowA"), rowB: $("rowB"), resRow: $("resRow"),
    algoFit: $("algoFit"),
    stepTitle: $("stepTitle"), stepText: $("stepText"), stepL: $("stepL"),
    stepAns: $("stepAns"),
    animLayer: $("animLayer"),
    confettiLayer: $("confettiLayer"),
    ruleNote: $("ruleNote"),
    errBox: $("errBox"),
    childEq: $("childEq"),
    childAns: $("childAns"),
    btnChildCheck: $("btnChildCheck"),
    childMsg: $("childMsg"),
    teachCard: $("teachCard"),
    lowerPanel: $("lowerPanel"),
    ren_o: $("ren_o"),
    ren_t: $("ren_t"),
    ren_h: $("ren_h"),
    ren_th: $("ren_th"),
  };

  /* =========================
     Confetti
     ========================= */
  function burstConfetti(){
    const layer = ui.confettiLayer;
    if (!layer) return;
    layer.innerHTML = "";

    const W = window.innerWidth || 800;
    const H = window.innerHeight || 600;
    const count = 140;

    for (let i=0;i<count;i++){
      const p = document.createElement("div");
      const size = 6 + Math.random()*8;
      const left = Math.random() * W;
      const top = -20 - Math.random()*H*0.25;

      p.style.position = "absolute";
      p.style.left = left + "px";
      p.style.top = top + "px";
      p.style.width = size + "px";
      p.style.height = (size * (0.7 + Math.random()*0.9)) + "px";
      p.style.borderRadius = (Math.random() < 0.25) ? "999px" : "3px";
      p.style.opacity = "0.95";
      p.style.transform = `rotate(${Math.random()*360}deg)`;

      const hue = Math.floor(Math.random()*360);
      p.style.background = `hsl(${hue} 90% 55%)`;

      layer.appendChild(p);

      const drift = (Math.random()*2 - 1) * W * 0.22;
      const endY = H + 80 + Math.random()*120;
      const rot = (Math.random()*2 - 1) * 980;
      const dur = 1200 + Math.random()*900;
      const delay = Math.random()*120;

      p.animate([
        { transform: `translate(0px, 0px) rotate(0deg)`, opacity: 1 },
        { transform: `translate(${drift}px, ${endY}px) rotate(${rot}deg)`, opacity: 1 }
      ], { duration: dur, delay, easing:"cubic-bezier(.2,.9,.2,1)", fill:"forwards" });

      p.animate([
        { opacity: 1 },
        { opacity: 0 }
      ], { duration: 450, delay: delay + dur - 350, easing:"ease-out", fill:"forwards" });
    }

    setTimeout(() => { layer.innerHTML = ""; }, 2600);
  }

  function pulseTeachingPanel(){
    ui.teachCard.classList.remove("pulseTeacher");
    ui.lowerPanel.classList.remove("pulseTeacher");
    void ui.teachCard.offsetWidth;
    ui.teachCard.classList.add("pulseTeacher");
    ui.lowerPanel.classList.add("pulseTeacher");
    setTimeout(() => {
      ui.teachCard.classList.remove("pulseTeacher");
      ui.lowerPanel.classList.remove("pulseTeacher");
    }, 1800);
  }

  /* =========================
     Audio
     ========================= */
  let audioCtx = null;
  function ensureAudio(){
    if (audioCtx) return audioCtx;
    const Ctx = window.AudioContext || window.webkitAudioContext;
    if (!Ctx) return null;
    audioCtx = new Ctx();
    return audioCtx;
  }
  function resumeAudioIfNeeded(){
    const ctx = ensureAudio();
    if (!ctx) return;
    if (ctx.state === "suspended") ctx.resume().catch(()=>{});
  }
  window.addEventListener("pointerdown", resumeAudioIfNeeded, { passive:true });

  function playClick(){
    const ctx = ensureAudio(); if (!ctx) return;
    const t0 = ctx.currentTime;
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = "square";
    o.frequency.setValueAtTime(760, t0);
    o.frequency.exponentialRampToValueAtTime(260, t0 + 0.03);
    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(0.22, t0 + 0.005);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.07);
    o.connect(g).connect(ctx.destination);
    o.start(t0);
    o.stop(t0 + 0.08);
  }

  function playSwoosh(){
    const ctx = ensureAudio(); if (!ctx) return;
    const t0 = ctx.currentTime;
    const dur = 0.30;
    const bufferSize = Math.floor(ctx.sampleRate * dur);
    const buf = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
    const data = buf.getChannelData(0);
    for (let i=0;i<bufferSize;i++){
      const x = i / bufferSize;
      const env = Math.sin(Math.PI * x);
      data[i] = (Math.random()*2-1) * env * 0.9;
    }
    const src = ctx.createBufferSource(); src.buffer = buf;
    const filter = ctx.createBiquadFilter();
    filter.type = "bandpass";
    filter.frequency.setValueAtTime(900, t0);
    filter.frequency.exponentialRampToValueAtTime(220, t0 + dur);
    const g = ctx.createGain();
    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(0.20, t0 + 0.05);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);
    src.connect(filter).connect(g).connect(ctx.destination);
    src.start(t0);
    src.stop(t0 + dur + 0.02);
  }

  function playClap(){
    const ctx = ensureAudio();
    if (!ctx) return;
    if (ctx.state === "suspended"){
      ctx.resume().then(() => playClap()).catch(()=>{});
      return;
    }

    const t0 = ctx.currentTime;
    const comp = ctx.createDynamicsCompressor();
    comp.threshold.setValueAtTime(-20, t0);
    comp.knee.setValueAtTime(18, t0);
    comp.ratio.setValueAtTime(6, t0);
    comp.attack.setValueAtTime(0.003, t0);
    comp.release.setValueAtTime(0.12, t0);
    comp.connect(ctx.destination);

    const mkBurst = (offset, dur, f0, q, gain) => {
      const start = t0 + offset;
      const len = Math.max(0.02, dur);
      const bufferSize = Math.floor(ctx.sampleRate * len);
      const buf = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
      const data = buf.getChannelData(0);

      for (let i=0;i<bufferSize;i++){
        const x = i / bufferSize;
        const env = Math.pow(1 - x, 2.6);
        data[i] = (Math.random()*2 - 1) * env;
      }

      const src = ctx.createBufferSource();
      src.buffer = buf;

      const bp = ctx.createBiquadFilter();
      bp.type = "bandpass";
      bp.frequency.setValueAtTime(f0, start);
      bp.Q.setValueAtTime(q, start);

      const hp = ctx.createBiquadFilter();
      hp.type = "highpass";
      hp.frequency.setValueAtTime(500, start);

      const g = ctx.createGain();
      g.gain.setValueAtTime(0.0001, start);
      g.gain.exponentialRampToValueAtTime(gain, start + 0.008);
      g.gain.exponentialRampToValueAtTime(0.0001, start + len);

      src.connect(bp);
      bp.connect(hp);
      hp.connect(g);
      g.connect(comp);

      src.start(start);
      src.stop(start + len + 0.01);
    };

    mkBurst(0.00, 0.13, 1600, 1.1, 0.70);
    mkBurst(0.03, 0.14, 1200, 1.0, 0.55);
    mkBurst(0.07, 0.11, 2200, 1.4, 0.40);
    mkBurst(0.10, 0.10, 900,  0.9, 0.30);
  }

  /* =========================
     Helpers
     ========================= */
  function cssVar(name){
    return getComputedStyle(document.documentElement).getPropertyValue(name).trim() || "ease";
  }
  function cssMs(name){
    const v = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    if (v.endsWith("ms")) return parseFloat(v);
    if (v.endsWith("s")) return parseFloat(v) * 1000;
    const n = parseFloat(v);
    return Number.isFinite(n) ? n : 900;
  }
  const wait = (ms)=> new Promise(res => setTimeout(res, ms));

  function showErr(msg){
    ui.errBox.style.display = msg ? "block" : "none";
    ui.errBox.textContent = msg || "";
  }

  function clampCents(n){
    if (!Number.isFinite(n)) n = 0;
    n = Math.round(n / STEP_CENTS) * STEP_CENTS;
    n = Math.max(0, Math.min(MAX_CENTS, n));
    const ones = n % 10;
    if (ones !== 0 && ones !== 5){
      n = Math.round(n / 5) * 5;
    }
    return n;
  }

  function formatMoney(cents){
    cents = clampCents(cents);
    const dollars = Math.floor(cents / 100);
    const cc = (cents % 100).toString().padStart(2,"0");
    return `${dollars}.${cc}`;
  }
  function formatMoneyWith$(cents){
    return `$${formatMoney(cents)}`;
  }

  function parseMoneyToCents(raw){
    const s0 = String(raw ?? "").trim();
    if (!s0) return { cents: 0, ok:true, adjusted:false };

    const s = s0.replace(/\$/g,"").replace(/,/g,"").replace(/\s+/g,"");
    const m = s.match(/^(\d{1,4})(?:\.(\d{0,2}))?$/);
    if (!m) return { cents: 0, ok:false, adjusted:false };

    const dollars = parseInt(m[1],10);
    let centsPart = (m[2] ?? "");
    if (centsPart.length === 0) centsPart = "00";
    if (centsPart.length === 1) centsPart = centsPart + "0";
    const cc = parseInt(centsPart,10);

    if (!Number.isFinite(dollars) || !Number.isFinite(cc)) return { cents:0, ok:false, adjusted:false };
    if (dollars > MAX_DOLLARS) return { cents: MAX_CENTS, ok:true, adjusted:true };

    let total = dollars*100 + cc;
    total = Math.max(0, Math.min(MAX_CENTS, total));

    const snapped = clampCents(total);
    const adjusted = (snapped !== total) || ((snapped % 10) !== 0 && (snapped % 10) !== 5);

    return { cents: snapped, ok:true, adjusted };
  }

  function shade(hex, amt){
    const m = hex.trim().match(/^#?([0-9a-f]{6})$/i);
    if (!m) return hex;
    const n = parseInt(m[1], 16);
    let r=(n>>16)&255, g=(n>>8)&255, b=n&255;
    const mix = (c)=> Math.max(0, Math.min(255, Math.round(c + (amt>=0?(255-c)*amt:c*amt))));
    r = mix(r); g = mix(g); b = mix(b);
    return "#" + [r,g,b].map(v=>v.toString(16).padStart(2,"0")).join("");
  }

  function discStyle(placeKey){
    const base =
      (placeKey==="c5")   ? "#f472b6" :
      (placeKey==="c10")  ? "#60a5fa" :
      (placeKey==="d1")   ? "#34d399" :
      (placeKey==="d10")  ? "#38bdf8" :
      (placeKey==="d100") ? "#fb923c" :
      (placeKey==="d1000")? "#a78bfa" :
      "#f59e0b";
    const rim  = shade(base, -0.22);
    const top  = shade(base, +0.18);
    const bot  = shade(base, -0.10);
    return { fill: `linear-gradient(180deg, ${top} 0%, ${base} 55%, ${bot} 100%)`, rim };
  }

  /* =========================
     Token factory
     ========================= */
  let displayMode = "notes";

  function makeCoinEl(numText, unitText, colorClass){
    const c = document.createElement("div");
    c.className = "coin " + (colorClass || "");
    const ring = document.createElement("div"); ring.className = "ring";
    const inner = document.createElement("div"); inner.className = "inner";
    const sp = document.createElement("span"); sp.textContent = numText;
    const sm = document.createElement("small"); sm.textContent = unitText;
    inner.appendChild(sp);
    inner.appendChild(sm);
    c.appendChild(ring);
    c.appendChild(inner);
    return c;
  }

  function makeNoteEl(mainText, smallText, extraClass){
    const n = document.createElement("div");
    n.className = "noteCard " + (extraClass || "");
    const wrap = document.createElement("div");
    const big = document.createElement("div");
    big.textContent = mainText;
    big.style.fontSize = "16px";
    big.style.fontWeight = "1000";
    const sm = document.createElement("small");
    sm.textContent = smallText || "";
    wrap.appendChild(big);
    if (smallText) wrap.appendChild(sm);
    n.appendChild(wrap);
    return n;
  }

  function makeOctCoinEl(){
    const o = document.createElement("div");
    o.className = "coinOct";
    const wrap = document.createElement("div");
    const big = document.createElement("span");
    big.textContent = "$1";
    const sm = document.createElement("small");
    sm.textContent = "coin";
    wrap.appendChild(big);
    wrap.appendChild(sm);
    o.appendChild(wrap);
    return o;
  }

  function makeTokenEl(placeKey){
    const el = document.createElement("div");
    el.className = "token";
    el.dataset.place = placeKey;

    if (displayMode === "coins"){
      const st = discStyle(placeKey);
      const d = document.createElement("div");
      d.className = "disc";
      d.style.setProperty("--discFill", st.fill);
      d.style.setProperty("--discRim", st.rim);
      d.textContent = PLACE_META[placeKey]?.short || "?";
      el.appendChild(d);
      return el;
    }

    let graphic = null;
    if (placeKey === "c5")  graphic = makeCoinEl("5", "Â¢", "c5");
    if (placeKey === "c10") graphic = makeCoinEl("10", "Â¢", "c10");
    if (placeKey === "d1")  graphic = makeOctCoinEl();
    if (placeKey === "d10") graphic = makeNoteEl("$10", "note", "ten");
    if (placeKey === "d100") graphic = makeNoteEl("$100", "note", "fifty");
    if (placeKey === "d1000") graphic = makeNoteEl("$1000", "note", "thou");
    if (!graphic) graphic = makeCoinEl("?", "", "");
    el.appendChild(graphic);
    return el;
  }

  /* =========================
     Pile layout helpers
     ========================= */
  function ensureTwoColStructure(pileEl){ /* no-op */ }

  function flattenTokens(pileEl){
    if (!pileEl) return [];
    return Array.from(pileEl.children).filter(
      n => n && n.nodeType === 1 && n.classList.contains("token")
    );
  }

  function putTokenTwoCol(pileEl, tokenEl){
    pileEl.appendChild(tokenEl);
  }

  function repackPile(pileEl, placeKey){
    const tokens = flattenTokens(pileEl);
    pileEl.innerHTML = "";
    pileEl.dataset.place = placeKey;
    pileEl.className = "pile pileTwoCol";
    ensureTwoColStructure(pileEl);
    for (const t of tokens) putTokenTwoCol(pileEl, t);
  }

  /* =========================
     Smooth move animation
     ========================= */
  async function moveTokensSmooth(tokens, toContainer, placeKey){
    if (!tokens.length) return;

    document.body.classList.add("animating");
    resumeAudioIfNeeded();
    playSwoosh();

    const starts = tokens.map(t => ({ el:t, r: t.getBoundingClientRect() }));

    tokens.forEach(t => {
      t.classList.add("movingHidden");
      toContainer.appendChild(t);
    });
    toContainer.getBoundingClientRect();

    const ends = tokens.map(t => ({ el:t, r: t.getBoundingClientRect() }));

    const anims = [];
    for (let i=0;i<tokens.length;i++){
      const { el } = starts[i];
      const sr = starts[i].r;
      const er = ends[i].r;

      const ghost = document.createElement("div");
      ghost.className = "ghost";
      ghost.style.width = sr.width + "px";
      ghost.style.height = sr.height + "px";
      ghost.style.transform = `translate(${sr.left}px, ${sr.top}px)`;
      ghost.style.opacity = "1";
      ghost.innerHTML = el.firstElementChild ? el.firstElementChild.outerHTML : el.outerHTML;

      ui.animLayer.appendChild(ghost);

      const a = ghost.animate([
        { transform:`translate(${sr.left}px, ${sr.top}px)`, opacity: 1 },
        { transform:`translate(${er.left}px, ${er.top}px)`, opacity: 1 }
      ], { duration: cssMs("--moveDur"), easing: cssVar("--ease"), fill:"forwards" });

      anims.push(a.finished.catch(()=>{}).then(() => ghost.remove()));
    }

    await Promise.all(anims);

    tokens.forEach(t => t.classList.remove("movingHidden"));
    repackPile(toContainer, placeKey);

    document.body.classList.remove("animating");
  }

  /* =========================
     General regroup
     ========================= */
  async function regroup(fromContainer, toContainer, placeFrom, placeTo, threshold){
    const tokens = Array.from(fromContainer.querySelectorAll(`.token[data-place="${placeFrom}"]`)).slice(0, threshold);
    if (tokens.length < threshold) return false;

    document.body.classList.add("animating");
    resumeAudioIfNeeded();
    playSwoosh();

    const ghosts = tokens.map(t => {
      const r = t.getBoundingClientRect();
      const g = document.createElement("div");
      g.className = "ghost";
      g.style.width = r.width + "px";
      g.style.height = r.height + "px";
      g.style.transform = `translate(${r.left}px, ${r.top}px)`;
      g.innerHTML = t.firstElementChild ? t.firstElementChild.outerHTML : t.outerHTML;
      ui.animLayer.appendChild(g);
      t.classList.add("movingHidden");
      return { token:t, ghost:g, rect:r };
    });

    const fr = fromContainer.getBoundingClientRect();
    const c = { x: fr.left + fr.width/2, y: fr.top + fr.height/2 };

    await Promise.all(ghosts.map(g => {
      const sr = g.rect;
      const jitterX = (Math.random()*14 - 7);
      const jitterY = (Math.random()*14 - 7);
      return g.ghost.animate([
        { transform:`translate(${sr.left}px, ${sr.top}px) scale(1)`, opacity: 1 },
        { transform:`translate(${c.x + jitterX}px, ${c.y + jitterY}px) scale(0.55)`, opacity: 1 }
      ], { duration: cssMs("--regroupDur"), easing: cssVar("--ease"), fill:"forwards" }).finished.catch(()=>{});
    }));

    playClick();

    await Promise.all(ghosts.map(g => g.ghost.animate([
      { opacity: 1 },
      { opacity: 0, transform: g.ghost.style.transform + " scale(0.25)", filter:"blur(0.8px)" }
    ], { duration: 320, easing:"ease-in", fill:"forwards" }).finished.catch(()=>{})));

    ghosts.forEach(g => { g.ghost.remove(); g.token.remove(); });

    resumeAudioIfNeeded();
    playSwoosh();

    const carryReal = makeTokenEl(placeTo);
    carryReal.classList.add("movingHidden");
    toContainer.appendChild(carryReal);
    repackPile(toContainer, placeTo);
    toContainer.getBoundingClientRect();

    const endR = carryReal.getBoundingClientRect();

    const ghostCarry = document.createElement("div");
    ghostCarry.className = "ghost";
    ghostCarry.style.width = endR.width + "px";
    ghostCarry.style.height = endR.height + "px";
    ghostCarry.innerHTML = carryReal.firstElementChild ? carryReal.firstElementChild.outerHTML : carryReal.outerHTML;
    ui.animLayer.appendChild(ghostCarry);

    const anim = ghostCarry.animate([
      { transform:`translate(${c.x}px, ${c.y}px) scale(0.65)`, opacity: 0.0 },
      { transform:`translate(${c.x}px, ${c.y}px) scale(0.65)`, opacity: 1.0, offset: 0.12 },
      { transform:`translate(${endR.left}px, ${endR.top}px) scale(1)`, opacity: 1.0 }
    ], { duration: cssMs("--moveDur"), easing: cssVar("--ease"), fill:"forwards" });

    await anim.finished.catch(()=>{});
    ghostCarry.remove();
    carryReal.classList.remove("movingHidden");

    document.body.classList.remove("animating");
    return true;
  }

  /* =========================
     Fit helpers
     ========================= */
  function fitAllPiles(){
    const zones = ui.zones.querySelectorAll(".zone");
    zones.forEach(z => {
      const fit = z.querySelector(".fitBox");
      if (!fit) return;
      fit.style.transform = "scale(1)";
      const availW = z.clientWidth - 10;
      const availH = z.clientHeight - 10;
      const contentW = fit.scrollWidth;
      const contentH = fit.scrollHeight;
      if (contentW < 1 || contentH < 1) return;
      const s = Math.min(1, availW / contentW, availH / contentH);
      fit.style.transform = `scale(${s})`;
    });
  }

  function fitAlgo(){
    ui.algoFit.style.transform = "scale(1)";
    const box = ui.algoFit.parentElement;
    const availW = box.clientWidth - 18;
    const availH = box.clientHeight - 18;
    const w = ui.algoFit.scrollWidth;
    const h = ui.algoFit.scrollHeight;
    if (w < 1 || h < 1) return;
    const s = Math.min(1, availW / w, availH / h);
    ui.algoFit.style.transform = `scale(${s})`;
  }

  /* =========================
     Money words (SG style)
     ========================= */
  const ONES = ["zero","one","two","three","four","five","six","seven","eight","nine"];
  const TEENS = ["ten","eleven","twelve","thirteen","fourteen","fifteen","sixteen","seventeen","eighteen","nineteen"];
  const TENS = ["","", "twenty","thirty","forty","fifty","sixty","seventy","eighty","ninety"];

  function twoDigitWords(n){
    n = n % 100;
    if (n < 10) return ONES[n];
    if (n < 20) return TEENS[n-10];
    const t = Math.floor(n/10), o = n%10;
    return o === 0 ? TENS[t] : `${TENS[t]}-${ONES[o]}`;
  }

  function numberToWordsSG(n){
    n = Math.floor(Math.abs(n));
    if (n === 0) return "zero";
    if (n < 100) return twoDigitWords(n);

    const joinHundreds = (x) => {
      const h = Math.floor(x/100);
      const r = x % 100;
      if (h === 0) return twoDigitWords(r);
      if (r === 0) return `${ONES[h]} hundred`;
      return `${ONES[h]} hundred and ${twoDigitWords(r)}`;
    };

    if (n < 1000) return joinHundreds(n);

    const thousands = Math.floor(n / 1000);
    const rem = n % 1000;

    const thouWords = (thousands < 10) ? `${ONES[thousands]} thousand` : `${twoDigitWords(thousands)} thousand`;
    if (rem === 0) return thouWords;

    const isExactHundreds = (rem % 100 === 0);
    const connector = (rem < 100 || isExactHundreds) ? " and " : ", ";

    let remWords = "";
    if (rem < 100) remWords = twoDigitWords(rem);
    else remWords = joinHundreds(rem);

    return thouWords + connector + remWords;
  }

  function moneyToWordsSG(cents){
    cents = clampCents(cents);
    const dollars = Math.floor(cents/100);
    const cc = cents % 100;

    const dWord = numberToWordsSG(dollars);
    const dollarUnit = (dollars === 1) ? "dollar" : "dollars";

    const cWord = numberToWordsSG(cc);
    const centUnit = (cc === 1) ? "cent" : "cents";

    return `${dWord} ${dollarUnit} and ${cWord} ${centUnit}`;
  }

  /* =========================
     Story prompts (original, generic)
     ========================= */
  const STORY_TEMPLATES = [
    (a,b)=>`(a) A toy costs ${formatMoneyWith$(a)}. A puzzle costs ${formatMoneyWith$(b)}. What is the total amount?`,
    (a,b)=>`(a) A water bottle costs ${formatMoneyWith$(a)}. A lunchbox costs ${formatMoneyWith$(b)}. What is the total amount?`,
    (a,b)=>`(a) A storybook costs ${formatMoneyWith$(a)}. A sticker set costs ${formatMoneyWith$(b)}. What is the total amount?`,
    (a,b)=>`(a) A notebook costs ${formatMoneyWith$(a)}. A ruler costs ${formatMoneyWith$(b)}. What is the total amount?`,
    (a,b)=>`(a) A snack costs ${formatMoneyWith$(a)}. A drink costs ${formatMoneyWith$(b)}. What is the total amount?`,
  ];
  function pickStory(a,b){
    const fn = STORY_TEMPLATES[Math.floor(Math.random()*STORY_TEMPLATES.length)];
    return fn(a,b);
  }

  /* =========================
     State
     ========================= */
  let A = 1275;
  let B = 860;

  let step = 0;
  let carry = {};
  let resultDigits = {};

  const zoneMap = { top:{}, bottom:{} };

  const renPref = { c5:"any", c10:"any", d1:"any", d10:"any" };

  let stepOrderMode = "centsFirst";

  function resetChildPanel(){
    ui.childEq.textContent = `${formatMoneyWith$(A)} + ${formatMoneyWith$(B)}`;
    ui.childAns.value = "";
    ui.childMsg.className = "childMsg";
    ui.childMsg.style.display = "none";
    ui.childMsg.textContent = "";
  }

  function countsFromCents(cents){
    cents = clampCents(cents);
    const dollars = Math.floor(cents/100);
    const cc = cents % 100;
    const c10 = Math.floor(cc/10);
    const c1 = cc % 10;
    return {
      d100:  Math.floor(dollars/100)%10,
      d10:   Math.floor(dollars/10)%10,
      d1:    dollars%10,
      c10:   c10,
      c5:    (c1 === 5) ? 1 : 0
    };
  }

  function digitsFromCents(cents){
    cents = clampCents(cents);
    const dollars = Math.floor(cents/100);
    const cc = cents % 100;
    const c10 = Math.floor(cc/10);
    const c1 = cc % 10;
    return {
      d100:  Math.floor(dollars/100)%10,
      d10:   Math.floor(dollars/10)%10,
      d1:    dollars%10,
      c10:   c10,
      c5:    c1
    };
  }

  function resetProcess(){
    step = 0;
    carry = {};
    resultDigits = {};
    COLS.forEach(k => resultDigits[k] = null);

    ui.eqAns.textContent = "$?";
    ui.eqHint.textContent = "Click Next Step";
    ui.ansWords.style.display = "none";
    ui.ansWordsText.textContent = "";
    ui.btnDone.disabled = true;
    ui.btnNext.disabled = false;
    ui.mat.classList.remove("together");

    updateCarryDisplay();
    updateAlgoHighlight();
    renderStepCard();
    renderAlgoResults();
    resetChildPanel();
  }

  /* =========================
     Render (mat + algorithm)
     ========================= */
  function ensureLockedDot(){
    const existing = ui.mat.querySelector("#lockedDot");
    if (existing) existing.remove();

    const dot = document.createElement("div");
    dot.id = "lockedDot";
    dot.className = "dotSimple";
    dot.style.left = `calc(${(DOT_INDEX / COLS.length) * 100}% - 9px)`;
    dot.style.top = "50%";
    dot.style.transform = "translateY(-50%)";
    ui.mat.appendChild(dot);
  }

  function renderAll(){
    A = clampCents(A);
    B = clampCents(B);

    ui.pillA.textContent = formatMoneyWith$(A);
    ui.pillB.textContent = formatMoneyWith$(B);
    ui.eqA.textContent = formatMoneyWith$(A);
    ui.eqB.textContent = formatMoneyWith$(B);

    ui.prompt.textContent = pickStory(A, B);
    ui.childEq.textContent = `${formatMoneyWith$(A)} + ${formatMoneyWith$(B)}`;

    ui.ruleNote.textContent = "Tip: Always line up the decimal dots (.) . Regroup 2Ã—5Â¢ â†’ 10Â¢. Regroup 10Ã—10Â¢ â†’ $1.";

    ui.cols.style.setProperty("--cols", COLS.length);
    ui.zones.style.setProperty("--cols", COLS.length);

    ui.cols.innerHTML = "";
    COLS.forEach((k, idx) => {
      const d = document.createElement("div");
      d.className = "col tint" + (idx % 8);
      ui.cols.appendChild(d);
    });

    ui.mat.querySelectorAll(".vSep").forEach(el => el.remove());
    for (let i=1;i<COLS.length;i++){
      const v = document.createElement("div");
      v.className = "vSep";
      v.style.left = `calc(${(i/COLS.length)*100}% - 1px)`;
      ui.mat.appendChild(v);
    }

    ui.zones.innerHTML = "";
    zoneMap.top = {};
    zoneMap.bottom = {};

    const makeZone = (rowKey, placeKey) => {
      const z = document.createElement("div");
      z.className = "zone";
      z.dataset.row = rowKey;
      z.dataset.place = placeKey;

      const inner = document.createElement("div");
      inner.className = "zoneInner";

      const fit = document.createElement("div");
      fit.className = "fitBox";

      const pile = document.createElement("div");
      pile.className = "pile pileTwoCol";
      pile.dataset.place = placeKey;

      fit.appendChild(pile);
      inner.appendChild(fit);
      z.appendChild(inner);

      zoneMap[rowKey][placeKey] = { zone:z, pile };
      return z;
    };

    COLS.forEach(k => ui.zones.appendChild(makeZone("top", k)));
    COLS.forEach(k => ui.zones.appendChild(makeZone("bottom", k)));

    const ca = countsFromCents(A);
    const cb = countsFromCents(B);

    COLS.forEach(k => {
      fillPile(zoneMap.top[k].pile, k, ca[k] ?? 0);
      fillPile(zoneMap.bottom[k].pile, k, cb[k] ?? 0);
    });

    // âœ… locked dot on the mat (permanent)
    ensureLockedDot();

    renderAlgorithm(A, B);

    const okNoRegroup = isNoRegrouping(A, B);
    if (ui.orderSel){
      ui.orderSel.disabled = !okNoRegroup;
      if (!okNoRegroup){
        stepOrderMode = "centsFirst";
        ui.orderSel.value = "centsFirst";
      } else {
        ui.orderSel.value = stepOrderMode;
      }
    }

    resetProcess();

    requestAnimationFrame(() => {
      fitAllPiles();
      fitAlgo();
    });
  }

  function fillPile(pileEl, placeKey, count){
    pileEl.innerHTML = "";
    pileEl.dataset.place = placeKey;
    count = Math.max(0, Math.min(9, count|0));

    pileEl.className = "pile pileTwoCol";
    for (let i=0;i<count;i++){
      const tok = makeTokenEl(placeKey);
      putTokenTwoCol(pileEl, tok);
    }
  }

  function renderAlgorithm(aC, bC){
    ui.algoFit.style.setProperty("--colCount", COLS.length);

    ui.pvLabels.innerHTML = "";
    const dollarsSpan = document.createElement("div");
    dollarsSpan.className = "band dollars";
    dollarsSpan.textContent = "dollars";
    dollarsSpan.style.gridColumn = `1 / ${DOT_INDEX+1}`; // 1..3
    ui.pvLabels.appendChild(dollarsSpan);

    const centsSpan = document.createElement("div");
    centsSpan.className = "band cents";
    centsSpan.textContent = "cents";
    centsSpan.style.gridColumn = `${DOT_INDEX+1} / ${COLS.length+1}`; // 4..5
    ui.pvLabels.appendChild(centsSpan);

    const da = digitsFromCents(aC);
    const db = digitsFromCents(bC);

    const dollarsA = Math.floor(aC/100);
    const dollarsB = Math.floor(bC/100);

    const firstDollarColIndexA = (() => {
      if (dollarsA >= 100)  return 0;
      if (dollarsA >= 10)   return 1;
      return 2;
    })();

    const firstDollarColIndexB = (() => {
      if (dollarsB >= 100)  return 0;
      if (dollarsB >= 10)   return 1;
      return 2;
    })();

    const makeRowSpans = (digitsMap, firstDollarColIndex) => {
      const out = [];
      COLS.forEach((k, idx) => {
        if (idx < DOT_INDEX){
          const val = digitsMap[k] ?? 0;
          const blank = (idx < firstDollarColIndex) && (val === 0);
          out.push({ ch: String(val), blank });
        } else {
          const val = digitsMap[k];
          out.push({ ch: String(val), blank:false });
        }
      });
      return out;
    };

    const ra = makeRowSpans(da, firstDollarColIndexA);
    const rb = makeRowSpans(db, firstDollarColIndexB);

    ui.rowA.innerHTML = "";
    ra.forEach(obj => {
      const sp = document.createElement("span");
      sp.textContent = obj.ch;
      if (obj.blank) sp.classList.add("blank");
      ui.rowA.appendChild(sp);
    });

    ui.rowB.innerHTML = "";
    rb.forEach(obj => {
      const sp = document.createElement("span");
      sp.textContent = obj.ch;
      if (obj.blank) sp.classList.add("blank");
      ui.rowB.appendChild(sp);
    });

    ui.carryRow.innerHTML = "";
    COLS.forEach(() => {
      const sp = document.createElement("span");
      sp.textContent = "";
      sp.classList.add("blank");
      ui.carryRow.appendChild(sp);
    });

    ui.resRow.innerHTML = "";
    COLS.forEach((k) => {
      const b = document.createElement("div");
      b.className = "resBox mystery";
      b.id = "res_" + k;
      b.textContent = "?";
      ui.resRow.appendChild(b);
    });

    requestAnimationFrame(fitAlgo);
  }

  function updateCarryDisplay(){
    const spans = Array.from(ui.carryRow.children);
    const anyCarry = ["c10","d1","d10","d100"].some(k => (carry[k]||0) > 0);

    COLS.forEach((k, idx) => {
      const sp = spans[idx];
      if (!sp) return;

      if (!anyCarry){
        sp.textContent = "";
        sp.className = "blank";
        return;
      }

      const v = carry[k] || 0;
      if (v === 0){
        sp.textContent = "";
        sp.className = "blank";
      } else {
        sp.textContent = String(v);
        sp.className = "carry";
      }
    });

    if (!anyCarry){
      spans.forEach(sp => { sp.textContent = ""; sp.className = "blank"; });
    }
  }

  function renderAlgoResults(){
    const sum = clampCents(A + B);
    const dollarsSum = Math.floor(sum/100);

    const ds = digitsFromCents(sum);
    const firstDollarColIndexS = (() => {
      if (dollarsSum >= 100)  return 0;
      if (dollarsSum >= 10)   return 1;
      return 2;
    })();

    COLS.forEach((k, idx) => {
      const box = document.getElementById("res_" + k);
      const v = resultDigits[k];
      if (!box) return;

      if (v === null || v === undefined){
        box.textContent = "?";
        box.classList.add("mystery");
        box.classList.remove("blankish");
        return;
      }

      if (idx < DOT_INDEX){
        const showBlank = (idx < firstDollarColIndexS) && (v === 0);
        if (showBlank){
          box.textContent = "";
          box.classList.add("blankish");
          box.classList.remove("mystery");
        } else {
          box.textContent = String(v);
          box.classList.remove("mystery");
          box.classList.remove("blankish");
        }
        return;
      }

      box.textContent = String(v);
      box.classList.remove("mystery");
      box.classList.remove("blankish");
    });

    const done = getStepPlaces().every(k => resultDigits[k] !== null);
    if (done){
      ui.eqAns.textContent = formatMoneyWith$(sum);
      ui.eqHint.textContent = "Done!";
      ui.btnDone.disabled = false;
      ui.btnNext.disabled = true;
      ui.mat.classList.add("together");

      ui.ansWordsText.textContent = moneyToWordsSG(sum);
      ui.ansWords.style.display = "block";

      // âœ… keep dot visible even when together
      ensureLockedDot();
    } else {
      ui.eqAns.textContent = "$?";
      ui.ansWords.style.display = "none";
      ensureLockedDot();
    }
  }

  function getStepPlaces(){
    const centsFirst  = ["c5","c10","d1","d10","d100"];
    const dollarsFirst= ["d1","d10","d100","c10","c5"];
    return (stepOrderMode === "dollarsFirst") ? dollarsFirst : centsFirst;
  }

  function updateAlgoHighlight(){
    ui.resRow.querySelectorAll(".resBox").forEach(b => {
      b.style.outline = "none";
      b.style.outlineOffset = "0px";
    });

    const order = getStepPlaces();
    const currentPlace = order[step] || null;
    if (currentPlace){
      const target = document.getElementById("res_" + currentPlace);
      if (target){
        target.style.outline = "3px dashed rgba(236,72,153,.85)";
        target.style.outlineOffset = "6px";
      }
    }
  }

  function renderStepCard(){
    const order = getStepPlaces();
    const p = order[step] || null;

    if (!p){
      ui.stepTitle.textContent = "DONE";
      ui.stepText.textContent = "All money tokens are together.";
      ui.stepL.textContent = "Great!";
      ui.stepAns.textContent = "âœ“";
      ui.stepAns.classList.remove("mystery");
      return;
    }

    ui.stepTitle.textContent = `STEP ${step + 1}`;

    const da = digitsFromCents(A);
    const db = digitsFromCents(B);
    const carryIn = carry[p] || 0;

    if (p === "c5"){
      ui.stepText.textContent = "Add the ones of cents (0 or 5).";
      const aV = da.c5, bV = db.c5;
      ui.stepL.textContent = `${aV}Â¢ + ${bV}Â¢`;
    } else if (p === "c10"){
      ui.stepText.textContent = "Add the tens of cents.";
      const aV = da.c10, bV = db.c10;
      ui.stepL.textContent = carryIn ? `${aV} tens + ${bV} tens + ${carryIn} ten` : `${aV} tens + ${bV} tens`;
    } else if (p === "d1"){
      ui.stepText.textContent = "Add the dollars (ones).";
      const aV = da.d1, bV = db.d1;
      ui.stepL.textContent = carryIn ? `${aV} + ${bV} + ${carryIn}` : `${aV} + ${bV}`;
    } else if (p === "d10"){
      ui.stepText.textContent = "Add the dollars (tens).";
      const aV = da.d10, bV = db.d10;
      ui.stepL.textContent = carryIn ? `${aV} + ${bV} + ${carryIn}` : `${aV} + ${bV}`;
    } else {
      ui.stepText.textContent = "Add the dollars (hundreds).";
      const aV = da.d100, bV = db.d100;
      ui.stepL.textContent = carryIn ? `${aV} + ${bV} + ${carryIn}` : `${aV} + ${bV}`;
    }

    const v = resultDigits[p];
    if (v === null){
      ui.stepAns.textContent = "?";
      ui.stepAns.classList.add("mystery");
    } else {
      ui.stepAns.textContent = (p === "c5") ? `${v}Â¢` : String(v);
      ui.stepAns.classList.remove("mystery");
    }
  }

  /* =========================
     Step logic
     ========================= */
  let busy = false;

  async function normalizePileCount(pileEl, placeKey, desiredCount){
    const tokens = Array.from(pileEl.querySelectorAll(`.token[data-place="${placeKey}"]`));
    if (tokens.length <= desiredCount) return;
    const extras = tokens.slice(desiredCount);
    extras.forEach(t => t.classList.add("movingHidden"));
    await wait(140);
    extras.forEach(t => t.remove());
    repackPile(pileEl, placeKey);
  }

  function nextPlaceOf(placeKey){
    const order = getStepPlaces();
    const idx = order.indexOf(placeKey);
    return (idx >= 0) ? (order[idx+1] || null) : null;
  }

  async function doNextStep(){
    if (busy) return;

    const order = getStepPlaces();
    const p = order[step];
    if (!p) return;

    busy = true;

    const fromPile = zoneMap.bottom[p].pile;
    const toPile   = zoneMap.top[p].pile;

    const moving = Array.from(fromPile.querySelectorAll(`.token[data-place="${p}"]`));
    await moveTokensSmooth(moving, toPile, p);
    repackPile(fromPile, p);

    const ca = countsFromCents(A);
    const cb = countsFromCents(B);

    const carryIn = carry[p] || 0;
    const aCount = ca[p] || 0;
    const bCount = cb[p] || 0;

    const base = BASE[p] || 10;
    const total = aCount + bCount + carryIn;
    const remainderCount = total % base;
    const carryOutCount = Math.floor(total / base);

    const displayDigit = (p === "c5") ? (remainderCount * 5) : remainderCount;

    resultDigits[p] = displayDigit;
    renderAlgoResults();

    const nxt = nextPlaceOf(p);

    if (carryOutCount > 0 && nxt){
      carry[nxt] = (carry[nxt] || 0) + carryOutCount;
      updateCarryDisplay();

      const threshold = base;
      const did = await regroup(toPile, zoneMap.top[nxt].pile, p, nxt, threshold);
      if (!did){
        const carryTok = makeTokenEl(nxt);
        zoneMap.top[nxt].pile.appendChild(carryTok);
        repackPile(zoneMap.top[nxt].pile, nxt);
        playClick();
      } else {
        repackPile(zoneMap.top[nxt].pile, nxt);
      }

      await normalizePileCount(toPile, p, remainderCount);
    } else {
      await normalizePileCount(toPile, p, remainderCount);
    }

    repackPile(toPile, p);

    step += 1;

    updateCarryDisplay();
    updateAlgoHighlight();
    renderStepCard();

    fitAllPiles();
    fitAlgo();
    ensureLockedDot();

    const done = order.every(k => resultDigits[k] !== null);
    if (done){
      ui.btnDone.disabled = false;
      ui.btnNext.disabled = true;
      ui.mat.classList.add("together");
      ensureLockedDot();
    }

    busy = false;
  }

  /* =========================
     Random with renaming prefs
     ========================= */
  function randInt(min, max){ return Math.floor(min + Math.random() * (max - min + 1)); }

  function randomAmountCents(maxDollarsFloat){
    const maxC = Math.min(MAX_CENTS, Math.round(parseFloat(maxDollarsFloat || "999.95") * 100));
    const steps = Math.floor(maxC / STEP_CENTS);
    return clampCents(randInt(0, steps) * STEP_CENTS);
  }

  function computeCarryOutsMoney(aC, bC){
    const a = countsFromCents(aC);
    const b = countsFromCents(bC);

    const order = ["c5","c10","d1","d10","d100"];
    let carryIn = 0;
    const out = { c5:0, c10:0, d1:0, d10:0, d100:0 };

    for (const p of order){
      const base = BASE[p] || 10;
      const total = (a[p]||0) + (b[p]||0) + carryIn;
      const carryOut = Math.floor(total / base);
      out[p] = carryOut;
      carryIn = carryOut;
    }
    return out;
  }

  function isNoRegrouping(aC, bC){
    const co = computeCarryOutsMoney(aC, bC);
    return (co.c5===0 && co.c10===0 && co.d1===0 && co.d10===0 && co.d100===0);
  }

  function matchesRenamingPrefs(aC, bC, prefs){
    const co = computeCarryOutsMoney(aC, bC);
    const checks = ["c5","c10","d1","d10"];
    for (const k of checks){
      const want = prefs[k] || "any";
      const hasCarry = (co[k] || 0) > 0;
      if (want === "rename" && !hasCarry) return false;
      if (want === "no" && hasCarry) return false;
    }
    return true;
  }

  function randomWithRenaming(maxDollars, prefs){
    const tries = 4500;
    for (let i=0;i<tries;i++){
      const a = randomAmountCents(maxDollars);
      const b = randomAmountCents(maxDollars);
      if (matchesRenamingPrefs(a, b, prefs)) return { a, b, ok:true };
    }
    return { a: randomAmountCents(maxDollars), b: randomAmountCents(maxDollars), ok:false };
  }

  function applyNumbers(aCents, bCents){
    A = clampCents(aCents);
    B = clampCents(bCents);
    ui.inA.value = formatMoney(A);
    ui.inB.value = formatMoney(B);
    showErr("");
    renderAll();
  }

  /* =========================
     Child panel logic
     ========================= */
  function setChildMsg(kind, text){
    ui.childMsg.className = "childMsg " + kind;
    ui.childMsg.textContent = text;
    ui.childMsg.style.display = "block";
  }

  function checkChildAnswer(){
    resumeAudioIfNeeded();
    const raw = String(ui.childAns.value ?? "").trim();
    if (!raw){
      setChildMsg("bad", "Type your answer first ðŸ™‚");
      playClick();
      return;
    }

    const s = raw.replace(/\$/g,"").replace(/,/g,"").trim();
    if (!/^\d{1,4}\.\d{2}$/.test(s)){
      setChildMsg("bad", "Please type 2 decimal places (e.g., 0.80, 21.35).");
      playClick();
      return;
    }

    const parsed = parseMoneyToCents(s);
    if (!parsed.ok){
      setChildMsg("bad", "Please type 2 decimal places (e.g., 0.80, 21.35).");
      playClick();
      return;
    }

    const guess = parsed.cents;
    const correct = clampCents(A + B);

    if (guess === correct){
      setChildMsg("ok", "ðŸŽ‰ Correct! Well done!");
      playClick();
      playClap();
      burstConfetti();
    } else {
      setChildMsg("bad", "Not yet. Check the aligned dots and add step-by-step, then try again.");
      playClick();
      pulseTeachingPanel();
    }
  }

  /* =========================
     Events
     ========================= */
  function syncRenPrefs(){
    renPref.c5  = ui.ren_o?.value  || "any";
    renPref.c10 = ui.ren_t?.value  || "any";
    renPref.d1  = ui.ren_h?.value  || "any";
    renPref.d10 = ui.ren_th?.value || "any";
  }
  ["ren_o","ren_t","ren_h","ren_th"].forEach(id => {
    const el = ui[id];
    if (el) el.addEventListener("change", () => { syncRenPrefs(); showErr(""); });
  });
  syncRenPrefs();

  if (ui.orderSel){
    ui.orderSel.addEventListener("change", () => {
      stepOrderMode = ui.orderSel.value || "centsFirst";
      resetProcess();
      updateAlgoHighlight();
      renderStepCard();
      fitAllPiles();
      fitAlgo();
      ensureLockedDot();
    });
  }

  ui.btnRandom.addEventListener("click", () => {
    showErr("");
    syncRenPrefs();
    const maxD = ui.digitsSel.value || "999.95";
    const r = randomWithRenaming(maxD, renPref);
    if (!r.ok){
      showErr("Could not satisfy all renaming choices together. Generated a random pair instead. Try setting some renaming options to 'Any'.");
    }
    applyNumbers(r.a, r.b);
  });

  ui.btnApply.addEventListener("click", () => {
    showErr("");

    const pa = parseMoneyToCents(ui.inA.value);
    const pb = parseMoneyToCents(ui.inB.value);

    if (!pa.ok || !pb.ok){
      showErr("Please type amounts like 12.75 (two decimal places).");
      return;
    }

    if (pa.adjusted || pb.adjusted){
      showErr("Adjusted to the nearest 5 cents (last digit must be 0 or 5).");
    }

    applyNumbers(pa.cents, pb.cents);
  });

  ui.btnSwap.addEventListener("click", () => {
    showErr("");
    const tmp = A; A = B; B = tmp;
    ui.inA.value = formatMoney(A);
    ui.inB.value = formatMoney(B);
    renderAll();
  });

  ui.btnReset.addEventListener("click", () => { showErr(""); renderAll(); });
  ui.btnNext.addEventListener("click", () => doNextStep());

  ui.btnChildCheck.addEventListener("click", checkChildAnswer);
  ui.childAns.addEventListener("keydown", (e) => { if (e.key === "Enter") checkChildAnswer(); });

  window.addEventListener("resize", () => {
    requestAnimationFrame(() => {
      fitAllPiles();
      fitAlgo();
      ensureLockedDot();
    });
  });

  /* =========================
     INIT
     ========================= */
  ui.inA.value = "12.75";
  ui.inB.value = "8.60";
  renderAll();
})();
</script>

</body>
</html>
